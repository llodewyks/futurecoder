server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;

  # Redirect site root to /course/
  location = / { return 302 /course/; }

  # --- Serve Pyodide archives BEFORE SPA fallback ---
  # Futurecoder / Pyodide sometimes request hashed CRA paths; handle both.
  location ~ ^/course/(?:static/js/static/media/)?python_core\.tar.*$ {
    default_type application/x-bzip2;
    try_files /course/python_core.tar =404;
  }
  location ~ ^/course/(?:static/js/static/media/)?python_stdlib\.zip.*$ {
    default_type application/zip;
    try_files /course/python_stdlib.zip =404;
  }

  # Static assets served as-is
  location ~ ^/course/(static|pyodide|wheels|packages)/ {
    try_files $uri =404;
  }
  location ~ ^/course/.*\.(wasm|whl|data|js|css|map|json)$ {
    try_files $uri =404;
  }

  # SPA fallback for the rest of /course/
  location /course/ {
    try_files $uri $uri/ /course/index.html;
  }

  # Simple health check
  location = /healthz { return 200 "ok\n"; add_header Content-Type text/plain; }
}
